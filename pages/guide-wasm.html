<!DOCTYPE html>
<html lang="en-US">

<head>
  <title>WASM Basics - My web guide</title>
  <base href=".." />

  <!-- iPad Pro with high-resolution Retina display: -->
  <link
    rel="apple-touch-icon"
    sizes="167x167"
    href="images/icon/apple-touch-icon-167x167.png" />
  <!-- 3x resolution iPhone: -->
  <link
    rel="apple-touch-icon"
    sizes="180x180"
    href="images/icon/apple-touch-icon-180x180.png" />
  <!-- non-Retina iPad, iPad mini, etc.: -->
  <link
    rel="apple-touch-icon"
    sizes="152x152"
    href="images/icon/apple-touch-icon-152x152.png" />
  <!-- 2x resolution iPhone and other devices: -->
  <link
    rel="apple-touch-icon"
    href="images/icon/apple-touch-icon-120x120.png" />
  <!-- basic favicon -->
  <link rel="icon" href="images/icon/favicon-32x32.ico" type="image/x-icon" />

  <!-- Metadata -->
  <meta charset="utf-8" />
  <meta name="author" content="Emanuele Rovini" />
  <meta name="description" content="Simple example-based guide for creating a website." />
  <meta name="keywords" content="Web, HTML, CSS, JS, WASM, guide" />
  <meta name="theme-color" content="white" />
  <meta name="color-scheme" content="only light" />
  <meta name="viewport" content="width=device-width">

  <!-- Stylesheets -->
  <link
   rel="stylesheet"
   href="styles/style.css" />

  <!--
  <link
   rel="stylesheet"
   href="https://fred-wang.github.io/MathFonts/LatinModern/mathfonts.css" />
   -->
  <!-- @Speed: Downloading and using this font is what makes the page flicker on reload. If we
       render math with Cambria, the reload is instantaneous (but Cambria doesn't stretch operators
       correctly) -->

  <!-- Google font connection -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>

  <!-- Merriweather font -->
  <link href="https://fonts.googleapis.com/css2?family=Merriweather:ital,wght@0,300;0,400;0,700;0,900;1,300;1,400;1,700;1,900&display=swap" rel="stylesheet">

  <!-- Source Code Pro font -->
  <link href="https://fonts.googleapis.com/css2?family=Source+Code+Pro:ital,wght@0,200..900;1,200..900&display=swap" rel="stylesheet">
  
  <!-- Script to warn the user the browser doesn't support MathML -->
  <!-- <script src="https://fred-wang.github.io/mathml-warning.js/mpadded-min.js"></script> -->
</head>

<body>
  <a id="top"></a>

  <header>
    <a href="index.html">
      <img id="favicon" src="images/icon/apple-touch-icon-120x120.png"
       width="120" height="120"
       alt="The website logo, also serving as a link to the home page" title="My Web Guide" />
    </a>
    <span>My Web guide</span>
  </header>

  <!-- Breadcrumbs -->
  <!-- https://developer.mozilla.org/en-US/docs/Web/CSS/Layout_cookbook/Breadcrumb_Navigation -->
  <nav aria-label="Breadcrumb" class="breadcrumb">
    <ul>
      <li><a href="index.html">Home</a></li>
      <li><span aria-current="page">WASM Basics</span></li>
    </ul>
  </nav>

  <main>
  <article>

  <section>

  <!--
  ################
  ##### WASM #####
  ################
  -->

  <a href="pages/guide-wasm.html#wasm"><h1 id="wasm">Behaviour: WASM</h1></a>

  <!-- TODO(ema): Explain better what it is, not just how to build it -->

  <p>A modern companion to JavaScript, meant to be used alongside it, is WebAssembly.
The main difference between JS and WASM is that the latter <em>cannot</em> be stored and downloaded as <i>source code</i>.
It has to be compiled <em>ahead of time</em> and distributed as a <i>binary</i>.</p>

  <p>WebAssembly can be compiled from high-level languages (examples are C, C++, Rust, <a href="https://odin-lang.org/">Odin</a>), or from its 1:1 textual representation.
You can build WebAssembly written in its textual form using the <b>The WebAssembly Binary Toolkit</b>:
<a href="https://github.com/webassembly/wabt" class="external">https://github.com/webassembly/wabt</a>.</p> <!-- target="_blank" -->

  <!--
  ############################
  ##### WASM TEXT FORMAT #####
  ############################
  -->

  <a href="pages/guide-wasm.html#h2_wasm_text_format"><h2 id="h2_wasm_text_format">WASM text format</h2></a>

  <p>A WASM module is a tree. The textual representation of this tree is the S-expression, where each node of the tree goes inside a pair of parentheses.</p
>

  <div class="example">
  <pre><code class="lang_wasm">(this is a node)</code></pre>
  <pre><code class="lang_wasm">(this is the root node (this is a child node) (this is another child node))</code></pre>
  </div>

  <a href="pages/guide-wasm.html#h3_the_module_node"><h3 id="h3_the_module_node">The module node</h3></a>

  <p>The fundamental unit of code in WebAssembly is a module. The simplest module is the one made of just 1 node representing the module itself.</p>

  <div class="example">
  <pre><code class="lang_wasm">(module)</code></pre>
  </div>

  <!--
  #############################
  ##### THE FUNCTION NODE #####
  #############################
  -->

  <a href="pages/guide-wasm.html#h3_the_function_node"><h3 id="h3_the_function_node">The function node</h3></a>

  <div class="example">
  <pre><code class="lang_wasm">(func &lt;signature&gt; &lt;locals&gt; &lt;body&gt;)</code></pre>
  </div>

  <ul>
  <li>The <i>signature</i> declares the function parameters and return values.</li>
  <li>The <i>locals</i> are explicitly typed local variables.</li>
  <li>The <i>body</i> is a linear list of instructions.</li>
  </ul>

  <p>Parameters are defined with the <code>param</code> node:</p>

  <div class="example">
  <pre><code class="lang_wasm">(param &lt;type&gt;)</code></pre>
  </div>

  <p>For example:</p>

  <figure>
  <div class="example">
  <pre><code class="lang_wasm">(param i32)</code></pre>
  </div>
  <figcaption>A node defining a parameter of type <i>32-bit integer</i></figcaption>
  </figure>

  <p>Returns are the exact same, but they use the <code>return</code> node:</p>

  <div class="example">
  <pre><code class="lang_wasm">(return &lt;type&gt;)</code></pre>
  </div>

  <p>For example:</p>

  <figure>
  <div class="example">
  <pre><code class="lang_wasm">(return f32)</code></pre>
  </div>
  <figcaption>A node defining a return value of type <i>32-bit float</i></figcaption>
  </figure>

  <p>Note: the absence of a return node in a function signatures denotes that the function does not return any value.<br />
Note: the current WASM standard only supports 1 return value, but this limit is planned to be removed.</p>

  <p>Local variables are the same too, and they use the <code>local</code> node:</p>

  <div class="example">
  <pre><code class="lang_wasm">(local &lt;type&gt;)</code></pre>
  </div>

  <p>For example:</p>

  <figure>
  <div class="example">
  <pre><code class="lang_wasm">(local i32)</code></pre>
  </div>
  <figcaption>A node defining a local variable of type <i>32-bit integer</i></figcaption>
  </figure>

  <p>To put it all together, a complete function signature can look like this:</p>

  <figure>
  <div class="example">
  <pre><code class="lang_wasm">(func (param i32) (return i32) (local i64))</code></pre>
  </div>
  <figcaption>A node defining a function that takes an <code>i32</code> argument, returns a <code>i32</code> value and has a local <code>i64</code> variable</figcaption>
  </figure>

  <!--
  ###########################################
  ##### ACCESSING LOCALS AND PARAMETERS #####
  ###########################################
  -->

  <a href="pages/guide-wasm.html#h3_accessing_locals_and_parameters"><h3 id="h3_accessing_locals_and_parameters">Accessing locals and parameters</h3></a>

  <p>Parameters and variables are accessed by default by their <em>index</em>. Consider the following signature:</p>

  <div class="example">
  <pre><code class="lang_wasm">(func (param i32) (param f32) (local f64)</code></pre>
  </div>

  <p>The two parameters and the variable will be accessed by default by the indices <em>0, 1 and 2</em>.</p>

  <!--
  ####################
  ##### RUN WASM #####
  ####################
  -->

  <a href="pages/guide-wasm.html#h2_run_wasm"><h2 id="h2_run_wasm">Run WASM</h2></a>

  <p>See MDN on this topic: <a href="https://developer.mozilla.org/en-US/docs/WebAssembly/Guides/Loading_and_running">https://developer.mozilla.org/en-US/docs/WebAssembly/Guides/Loading_and_running</a></p>

  <a href="pages/guide-wasm.html#h3_run_wasm_with_script_tag"><h3 id="h3_run_wasm_with_script_tag">Run WASM with script tag</h3></a>

  <a href="pages/guide-wasm.html#h3_run_wasm_with_fetch"><h3 id="h3_run_wasm_with_fetch">Run WASM with fetch()</h3></a>

  <p>A WebAssembly module can be fetched with <a>fetch()</a> and then used by the <a>WebAssembly</a> object.</p>

  <p>The most efficient way to fetch a WASM module is to use the <a href="https://developer.mozilla.org/en-US/docs/WebAssembly/Reference/JavaScript_interface/instantiateStreaming_static"><code class="lang_js">WebAssembly.instantiateStreaming()</code></a> method. It will handle fetching, compiling, and instantiating the module in one step, accessing the raw byte code as it streams from the server:</p>

  <div class="example">
  <pre><code class="lang_js">WebAssembly.instantiateStreaming(source) // Signature</code></pre>
  <pre><code class="lang_js">/* Usage example */
WebAssembly.instantiateStreaming(fetch("my_wasm.wasm")).then(
	(fetchResult) => { /* ... */ }
);</code></pre>
  </div>

  <p>For example:</p>

  <div class="example">
  <pre><code class="lang_js">/* Usage example */
WebAssembly.instantiateStreaming(fetch("add.wasm")).then(
	(fetchResult) => {
		console.log(fetchResult.instance.exports.add(1, 2)); // "3"
	}
);</code></pre>
  </div>

  <p>"Access to fetch at 'file.wasm' from origin 'null' has been blocked by CORS policy"</p>

  <p>It happens if you load the html in the browser directly. Run a server and it works.</p> <!-- TODO(ema): Actually explai what's going on here -->

  <p><a href="pages/wasm-demos/hello-from-wat.html">See the demo.</a></p>

  <a href="pages/guide-wasm.html#h3_build_from_c_cpp"><h3 id="h3_build_from_c_cpp">Build from C/C++</h3></a>

  <p><a href="pages/wasm-demos/hello-from-c.html">See the demo.</a></p>

  <!--
  ################################
  ##### BUILD WASM FROM ODIN #####
  ################################
  -->

  <a href="pages/guide-wasm.html#h3_build_from_odin"><h3 id="h3_build_from_odin">Build from Odin</h3></a>

  <p>The <a>Odin compiler</a> offers direct support for building to WebAssembly. If we run <code>odin build . -targets:?</code> on the command line, we get a list of all the supported targets. The list includes the following Wasm-related targets:</p>

  <pre><samp>freestanding_wasm32
        wasi_wasm32
          js_wasm32
        orca_wasm32
freestanding_wasm64p32
          js_wasm64p32
        wasi_wasm64p32
</samp></pre>

  <p>Each target name is made of 2 parts: the "operating system"/language runtime, and the architecture. The "operating system" part refers to what implementation to use for the Odin language runtime, such as the initialization of the <code class="lang_odin">context</code> structure and memory allocation.<br />
"Freestanding" means no os, and "js" means the JS wrapper included by default in the Odin compiler.</p>

  <!-- https://forum.odin-lang.org/t/so-many-different-wasm-build-targets/790 -->

  <p>When you write your Odin code, all the functions marked with the <code>@export</code> attribute will be exported into the WASM module. Remember to declare them as having the <code>&quot;c&quot;</code> calling convention.</p>

  <div class="example">
  <pre><code class="lang_odin">package my_wasm_package

@(export)
add :: proc &quot;c&quot; (a, b: i32) -> i32 {
	return a + b
}</code></pre>
  </div>

  <!--
  ###################################
  ##### BUILD WASM FROM ODIN JS #####
  ###################################
  -->

  <h4>Build from Odin with target:js</h4>

  <p>The simplest way to build an Odin package to WASM is to use the <code>js_wasm32</code> target. Use the following command to build an Odin package to a WASM module:</p>

  <pre><code>odin build . -target:js_wasm32 -no-entry-point</code></pre>
 
  <p>You can <a href="pages/wasm-demos/hello-from-odin-js.html">look at a demo page that calls this code</a> or see the source on GitHub: <a></a>.</p>

  <!--
  #############################################
  ##### BUILD WASM FROM ODIN FREESTANDING #####
  #############################################
  -->

  <h4>Build from Odin with target:freestanding</h4>

  <p>Another way is to build to the <code>freestanding_wasm32</code> target.</p>

  <p><a href="pages/wasm-demos/hello-from-odin-freestanding.html">See the demo.</a></p>

  </section>

  </article>
  </main>

  <footer>
  <a class="anchor-button" href="pages/guide-wasm.html#top">Back to top</a>
  </footer>

  <script src="scripts/syntax-highlight.js" defer></script>
  <script src="scripts/script.js" defer></script>
</body>

</html>
